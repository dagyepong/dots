#!/usr/bin/env bash
########################################################
#
#    в–„в–Ҳ    в–Ҳв–„     в–„в–Ҳ        в–„в–Ҳ     в–Ҳв–„    в–„в–„в–„в–„в–Ҳв–Ҳв–Ҳв–„в–„в–„в–„
#   в–Ҳв–Ҳв–Ҳ    в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ       в–Ҳв–Ҳв–Ҳ     в–Ҳв–Ҳв–Ҳ в–„в–Ҳв–Ҳв–Җв–Җв–Җв–Ҳв–Ҳв–Ҳв–Җв–Җв–Җв–Ҳв–Ҳв–„
#   в–Ҳв–Ҳв–Ҳ    в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ       в–Ҳв–Ҳв–Ҳ     в–Ҳв–Ҳв–Ҳ в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ
#  в–„в–Ҳв–Ҳв–Ҳв–„в–„в–„в–„в–Ҳв–Ҳв–Ҳв–„в–„ в–Ҳв–Ҳв–Ҳ       в–Ҳв–Ҳв–Ҳ     в–Ҳв–Ҳв–Ҳ в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ
# в–Җв–Җв–Ҳв–Ҳв–Ҳв–Җв–Җв–Җв–Җв–Ҳв–Ҳв–Ҳв–Җ  в–Ҳв–Ҳв–Ҳ       в–Ҳв–Ҳв–Ҳ     в–Ҳв–Ҳв–Ҳ в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ
#   в–Ҳв–Ҳв–Ҳ    в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ       в–Ҳв–Ҳв–Ҳ     в–Ҳв–Ҳв–Ҳ в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ
#   в–Ҳв–Ҳв–Ҳ    в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳв–Ң    в–„ в–Ҳв–Ҳв–Ҳ в–„в–Ҳв–„ в–Ҳв–Ҳв–Ҳ в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Ҳв–Ҳ
#   в–Ҳв–Ҳв–Ҳ    в–Ҳв–Җ    в–Ҳв–Ҳв–Ҳв–Ҳв–Ҳв–„в–„в–Ҳв–Ҳ  в–Җв–Ҳв–Ҳв–Ҳв–Җв–Ҳв–Ҳв–Ҳв–Җ   в–Җв–Ҳ   в–Ҳв–Ҳв–Ҳ   в–Ҳв–Җ
#                в–Җ
#
#######################################################
# Make interrupt signals do nothing.
trap '' INT TSTP

hc() {
    herbstclient "$@"
}

hc emit_hook reload
hc lock

# Cyberpunk neon wallpaper
# Replace noisewall with your preferred wallpaper setter
feh --bg-fill ~/Pictures/cyberpunk-wallpaper.jpg  # or use your preferred cyberpunk wallpaper

#Load bindings sequentially, but lazily
{
    # Load keybinds/mousebinds
    ~/.config/herbstluftwm/bindings.sh

    # Load keychains
    ~/.config/herbstluftwm/keychain.sh
} &

# tags
tag_names=({1..9} 0)
tag_keys=({1..9} 0)
# Need this before tag creation
hc set default_frame_layout 'max'
hc substitute ALGO settings.default_frame_layout \
    foreach T tags.by-name. \
    sprintf ATTR '%c.tiling.root.algorithm' T \
    set_attr ATTR ALGO

hc rename default "${tag_names[0]}" || true
for i in "${!tag_names[@]}"; do
    hc add "${tag_names[$i]}"
    key="${tag_keys[$i]}"
    if [ -n "$key" ]; then
        hc keybind "Mod4-$key" substitute PRE tags.focus.index chain + use_index "$i" + or , compare tags.focus.index != PRE , use_previous
        hc keybind "Mod4-Shift-$key" move_index "$i"
    fi
done

# CYBERPUNK NEON THEME
hc set hide_covered_windows false
hc attr theme.tiling.reset 1
hc attr theme.floating.reset 1

# Cyberpunk color scheme - neon blues, magentas, and cyans
hc set frame_border_active_color '#00ffff'    # Neon cyan
hc set frame_border_normal_color '#1a1a2e'    # Dark blue-black
hc set frame_bg_normal_color '#16213e'        # Dark blue
hc set frame_bg_active_color '#0f3460'        # Medium blue
hc set frame_border_width 2
hc set always_show_frame 0
hc set frame_bg_transparent 0
hc set frame_transparent_width 0
hc set frame_gap 8
hc set focus_follows_mouse 1
hc set snap_gap 8

hc attr theme.tiling.reset 1
hc attr theme.floating.reset 1
hc attr theme.minimal.reset 1

hc attr theme.title_when 'multiple_tabs'
hc attr theme.title_align 'center'
hc attr theme.title_color '#ff00ff'           # Neon magenta
hc attr theme.title_font 'monospace:style=bold'
hc attr theme.title_height 18
hc attr theme.title_depth 20
hc attr theme.border_width 2
hc attr theme.tab_color '#1a1a2e'             # Dark blue-black
hc attr theme.inner_width 4
hc attr theme.outer_width 2

# Cyberpunk neon colors for window states
hc attr theme.active.color '#00ffff'          # Neon cyan for active windows
hc attr theme.normal.color '#ff00ff'          # Neon magenta for normal windows  
hc attr theme.urgent.color '#ffff00'          # Neon yellow for urgent windows
hc attr theme.inner_width 3
hc attr theme.border_width 4
hc attr theme.floating.border_width 3
hc attr theme.floating.outer_width 2
hc attr theme.floating.outer_color '#ff00ff'  # Neon magenta for floating windows
hc attr theme.padding_left 8

# Hide frame at startup for cleaner look
hc set frame_active_opacity 0

hc set window_gap 6
hc set smart_window_surroundings 0
hc set smart_frame_surroundings 0
hc set focus_stealing_prevention true
hc set mouse_recenter_gap 0
hc set focus_crosses_monitor_boundaries 1
hc set swap_monitors_to_get_tag 0
hc set raise_on_focus 1


# Dropdown scratchpad keybindings
hc keybind Mod4-s spawn ~/.config/herbstluftwm/scripts/dropdown_scratchpad.sh toggle
hc keybind Mod4-Shift-s spawn ~/.config/herbstluftwm/scripts/dropdown_scratchpad.sh menu
hc keybind Mod4-Control-s spawn ~/.config/herbstluftwm/scripts/dropdown_scratchpad.sh close

# Rules for dropdown windows
hc rule class='dropdown' tag=dropdown floating=on focus=on
hc rule title='dropdown' tag=dropdown floating=on focus=on
hc set_attr tags.by-name.dropdown.settings.floating on


# programs - consider adding cyberpunk-themed applications
hc spawn nitrogen --set-zoom-fill ~/Pictures/cyberpunk-wallpaper.jpg &
hc spawn sh $HOME/.config/polybar/launch.sh  # Make sure polybar has cyberpunk theme
hc spawn /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &
hc spawn plank &
hc spawn nm-applet &
hc spawn xfce4-power-manager &

# Dunst notifications with cyberpunk theme
pkill dunst
dunst -config ~/.config/dunst/dunstrc &

# Optional: Test notifications on startup
# sleep 5
# ~/.config/dunst/test-notifications.sh &
# rules
hc unrule -F
hc rule focus=on
hc rule instance=dropdown floating=on focus=on
hc rule class=Nsxiv floating=on floatplacement=center focus=on
hc rule class=mpv floating=on floatplacement=center focus=on
hc rule windowtype~'_NET_WM_WINDOW_TYPE_(DIALOG|UTILITY|SPLASH)' pseudotile=on
hc rule windowtype='_NET_WM_WINDOW_TYPE_DIALOG' focus=on floatplacement=center
hc rule windowtype~'_NET_WM_WINDOW_TYPE_(NOTIFICATION|DOCK|DESKTOP)' manage=off
hc rule class=qutebrowser tag=1
hc rule title=mutt tag=2
hc rule title=vit tag=2
hc rule title=ikhal tag=2
hc rule class=Zathura tag=4
hc rule class=Steam tag=5 floating=on floatplacement=center
hc rule title=weechat tag=6
hc rule title=Music tag=7

# unlock, just to be sure
for i in seq $(hc get monitors_locked); do
    hc unlock
done

herbstclient set tree_style 'в– в”ғ в”Јв”—в– в”Ғв”“'

# Autostart
if hc silent new_attr bool my_not_first_autostart; then
    # Load previously saved session
    if [ -f ~/.config/herbstluftwm/sessions/saved_session ]; then
        ~/.config/herbstluftwm/scripts/loadstate.sh &
    fi

    # Restart task spool list if one exists
    if [ -s $TS_SAVELIST ]; then
        $TS_SAVELIST && truncate -s 0 $TS_SAVELIST
    fi

    # Run these programs as user services
    uid=$(id -u)
    pgrep -U $uid runsv && pkill -U $uid runsv
    setsid -f runsvdir -P ~/.local/service

    # Launch bar (make sure yambar has cyberpunk theme)
    ~/.config/yambar/launch.sh

    # Things that require an internet connection
    while :; do
        [ "$(cat /sys/class/net/wlp5s0/carrier)" -eq 1 ] && break
    done
    network=$(iwctl station wlp5s0 show | grep 'Connected network' | xargs | cut -d' ' -f3-)
    case "$network" in
    Ollies*Network)
        sv start ~/.local/service/barrier
        ;;
    *)
        sudo -A wg-quick up barbarossvpn
        ;;
    esac

    # On startup, check for any new mails
    mailsync
fi

# Monitor setup
hc detect_monitors